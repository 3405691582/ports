From ded2e51e60325a0e817362c6df0c341bb00d4b0e Mon Sep 17 00:00:00 2001
From: Vsevolod Stakhov <vsevolod@rspamd.com>
Date: Sat, 22 Oct 2022 13:00:21 +0100
Subject: [PATCH] [CritFix] Restore compatibility with the integrations and
 headers alterations

Index: src/plugins/lua/milter_headers.lua
--- src/plugins/lua/milter_headers.lua.orig
+++ src/plugins/lua/milter_headers.lua
@@ -39,6 +39,7 @@ local settings = {
   skip_all = false,
   local_headers = {},
   authenticated_headers = {},
+  headers_modify_mode = 'compat', -- To avoid compatibility issues on upgrade
   default_headers_order = nil, -- Insert at the end (set 1 to insert just after the first received)
   routines = {
     ['remove-headers'] = {
@@ -572,7 +573,7 @@ local function milter_headers(task)
     lua_mime.modify_headers(task, {
       add = add,
       remove = remove
-    })
+    }, settings.headers_modify_mode)
   end
 end
 

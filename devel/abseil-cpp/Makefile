COMMENT =	abseil common libraries (c++)
CATEGORIES =	devel

GH_ACCOUNT =	abseil
GH_PROJECT =	${GH_ACCOUNT}-cpp
GH_TAGNAME =	20220623.1

HOMEPAGE =	https://abseil.io/

MAINTAINER =	Andrew Krasavin <noiseless-ak@yandex.ru>, \
		Klemens Nanni <kn@openbsd.org>

# Apache 2.0
PERMIT_PACKAGE =	Yes

SHARED_LIBS +=	absl_bad_any_cast_impl				1.0 # 2206.0.0
SHARED_LIBS +=	absl_bad_optional_access			1.0 # 2206.0.0
SHARED_LIBS +=	absl_bad_variant_access				1.0 # 2206.0.0
SHARED_LIBS +=	absl_base					1.0 # 2206.0.0
SHARED_LIBS +=	absl_city					1.0 # 2206.0.0
SHARED_LIBS +=	absl_civil_time					1.0 # 2206.0.0
SHARED_LIBS +=	absl_cord					1.0 # 2206.0.0
SHARED_LIBS +=	absl_cord_internal				1.0 # 2206.0.0
SHARED_LIBS +=	absl_cordz_functions				1.0 # 2206.0.0
SHARED_LIBS +=	absl_cordz_handle				1.0 # 2206.0.0
SHARED_LIBS +=	absl_cordz_info					1.0 # 2206.0.0
SHARED_LIBS +=	absl_cordz_sample_token				1.0 # 2206.0.0
SHARED_LIBS +=	absl_debugging_internal				1.0 # 2206.0.0
SHARED_LIBS +=	absl_demangle_internal				1.0 # 2206.0.0
SHARED_LIBS +=	absl_examine_stack				1.0 # 2206.0.0
SHARED_LIBS +=	absl_exponential_biased				1.0 # 2206.0.0
SHARED_LIBS +=	absl_failure_signal_handler			1.0 # 2206.0.0
SHARED_LIBS +=	absl_flags					1.0 # 2206.0.0
SHARED_LIBS +=	absl_flags_commandlineflag			1.0 # 2206.0.0
SHARED_LIBS +=	absl_flags_commandlineflag_internal		1.0 # 2206.0.0
SHARED_LIBS +=	absl_flags_config				1.0 # 2206.0.0
SHARED_LIBS +=	absl_flags_internal				1.0 # 2206.0.0
SHARED_LIBS +=	absl_flags_marshalling				1.0 # 2206.0.0
SHARED_LIBS +=	absl_flags_parse				1.0 # 2206.0.0
SHARED_LIBS +=	absl_flags_private_handle_accessor		1.0 # 2206.0.0
SHARED_LIBS +=	absl_flags_program_name				1.0 # 2206.0.0
SHARED_LIBS +=	absl_flags_reflection				1.0 # 2206.0.0
SHARED_LIBS +=	absl_flags_usage				1.0 # 2206.0.0
SHARED_LIBS +=	absl_flags_usage_internal			1.0 # 2206.0.0
SHARED_LIBS +=	absl_graphcycles_internal			1.0 # 2206.0.0
SHARED_LIBS +=	absl_hash					1.0 # 2206.0.0
SHARED_LIBS +=	absl_hashtablez_sampler				1.0 # 2206.0.0
SHARED_LIBS +=	absl_int128					1.0 # 2206.0.0
SHARED_LIBS +=	absl_log_severity				1.0 # 2206.0.0
SHARED_LIBS +=	absl_low_level_hash				1.0 # 2206.0.0
SHARED_LIBS +=	absl_malloc_internal				1.0 # 2206.0.0
SHARED_LIBS +=	absl_periodic_sampler				1.0 # 2206.0.0
SHARED_LIBS +=	absl_random_distributions			1.0 # 2206.0.0
SHARED_LIBS +=	absl_random_internal_distribution_test_util	1.0 # 2206.0.0
SHARED_LIBS +=	absl_random_internal_platform			1.0 # 2206.0.0
SHARED_LIBS +=	absl_random_internal_pool_urbg			1.0 # 2206.0.0
SHARED_LIBS +=	absl_random_internal_randen			1.0 # 2206.0.0
SHARED_LIBS +=	absl_random_internal_randen_hwaes		1.0 # 2206.0.0
SHARED_LIBS +=	absl_random_internal_randen_hwaes_impl		1.0 # 2206.0.0
SHARED_LIBS +=	absl_random_internal_randen_slow		1.0 # 2206.0.0
SHARED_LIBS +=	absl_random_internal_seed_material		1.0 # 2206.0.0
SHARED_LIBS +=	absl_random_seed_gen_exception			1.0 # 2206.0.0
SHARED_LIBS +=	absl_random_seed_sequences			1.0 # 2206.0.0
SHARED_LIBS +=	absl_raw_hash_set				1.0 # 2206.0.0
SHARED_LIBS +=	absl_raw_logging_internal			1.0 # 2206.0.0
SHARED_LIBS +=	absl_scoped_set_env				1.0 # 2206.0.0
SHARED_LIBS +=	absl_spinlock_wait				1.0 # 2206.0.0
SHARED_LIBS +=	absl_stacktrace					1.0 # 2206.0.0
SHARED_LIBS +=	absl_status					1.0 # 2206.0.0
SHARED_LIBS +=	absl_statusor					1.0 # 2206.0.0
SHARED_LIBS +=	absl_str_format_internal			1.0 # 2206.0.0
SHARED_LIBS +=	absl_strerror					1.0 # 2206.0.0
SHARED_LIBS +=	absl_strings					1.0 # 2206.0.0
SHARED_LIBS +=	absl_strings_internal				1.0 # 2206.0.0
SHARED_LIBS +=	absl_symbolize					1.0 # 2206.0.0
SHARED_LIBS +=	absl_synchronization				1.0 # 2206.0.0
SHARED_LIBS +=	absl_throw_delegate				1.0 # 2206.0.0
SHARED_LIBS +=	absl_time					1.0 # 2206.0.0
SHARED_LIBS +=	absl_time_zone					1.0 # 2206.0.0
SHARED_LIBS +=	absl_wyhash					1.0 # 2206.0.0

# C++17
COMPILER =		base-clang ports-gcc
COMPILER_LANGS=		c++
WANTLIB =		${COMPILER_LIBCXX} execinfo m
MODULES =		devel/cmake

CONFIGURE_ARGS +=	-DBUILD_SHARED_LIBS:BOOL=ON

# Force the same highest C++ standard because of ABI differences.
# https://github.com/abseil/abseil-cpp/issues/819
CONFIGURE_ARGS +=	-DCMAKE_CXX_STANDARD=17

# A future Abseil release will default ABSL_PROPAGATE_CXX_STD=ON
# for CMake >= 3.8. Abseil developers recommend enabling this option
# to ensure that our project builds correctly.
CONFIGURE_ARGS +=	-DABSL_PROPAGATE_CXX_STD:BOOL=ON

.if ${MACHINE_ARCH} == sparc64
# XXX hash/hash_test.cc:614:22: error: use of deleted function 'absl::lts_20211102::hash_internal::PoisonedHash::PoisonedHash()'
NO_TEST =		Yes
.else
# use googletest from ports
CONFIGURE_ARGS +=	-DABSL_USE_EXTERNAL_GOOGLETEST:BOOL=${LOCALBASE}/include/gtest
# turn on tests builds
CONFIGURE_ARGS +=	-DBUILD_TESTING:BOOL=ON \
			-DABSL_BUILD_TESTING:BOOL=ON

BUILD_DEPENDS +=	devel/gtest>=1.11.0pl20220208
TEST_DEPENDS +=		devel/gtest>=1.11.0pl20220208

# use TEST_TMPDIR instead of /tmp for tests temp data (like in bazel build)
TEST_ENV +=		TEST_TMPDIR=${WRKBUILD}/test_tmp \
			LD_LIBRARY_PATH=/usr/lib:${WRKBUILD}/test_lib

pre-test:
	@mkdir -p ${WRKBUILD}/test_tmp
	@mkdir -p ${WRKBUILD}/test_lib
	cd ${WRKBUILD}/test_lib && \
		 find ${WRKBUILD} -name "*\.so\.*\.*" | xargs -I {} ln -s {} .
.endif

.include <bsd.port.mk>

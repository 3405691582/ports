Contains:
 - https://github.com/stumpwm/stumpwm/commit/20d839f2ddfdfd25a8460152bc5dc45a9354e773
 - https://github.com/stumpwm/stumpwm/commit/f271a45e05fb25d70cdd4c12717d908fd9e27dee

Should be removed at the next release

Index: make-image.lisp.in
--- make-image.lisp.in.orig
+++ make-image.lisp.in
@@ -1,3 +1,5 @@
+(require :uiop)
+
 (in-package #:cl-user)
 
 (let* ((expected-warnings
@@ -48,7 +50,17 @@
     (uiop:symbol-call '#:asdf '#:register-immutable-system system-name)))
 
 (sb-ext:save-lisp-and-die "stumpwm" :toplevel (lambda ()
-                                                ;; asdf requires sbcl_home to be set, so set it to the value when the image was built
+                                                ;; stumpwm might be built in a fake enviroment, so use uiop:restore-image
+                                                ;; to compute the real uiop:*user-cache* for that user
+                                                (uiop:restore-image)
+                                                ;; and clean the asdf configuration to avoid some cached paths as well
+                                                (asdf:clear-configuration)
+                                                (asdf:clear-output-translations)
+                                                (asdf:initialize-output-translations
+                                                 '(:output-translations
+                                                   :enable-user-cache
+                                                   :ignore-inherited-configuration))
+                                                ;; asdf requires SBCL_HOME to be set, so set it to the value when the image was built
                                                 (alexandria:when-let ((home #.(sb-ext:posix-getenv "SBCL_HOME")))
                                                   (sb-posix:putenv (format nil "SBCL_HOME=~A" home)))
                                                 (stumpwm:stumpwm)
